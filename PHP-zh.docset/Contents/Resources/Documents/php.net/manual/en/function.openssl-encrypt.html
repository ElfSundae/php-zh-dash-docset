<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>Encrypts data</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.openssl-digest.html">? openssl_digest</a></li>
      <li style="float: right;"><a href="function.openssl-error-string.html">openssl_error_string ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.openssl.html">OpenSSL 函数</a></li>
    <li>Encrypts data</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.openssl-encrypt" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">openssl_encrypt</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.3.0)</p><p class="refpurpose"><span class="refname">openssl_encrypt</span> &mdash; <span class="dc-title">Encrypts data</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.openssl-encrypt-description">
  <h3 class="title">说明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">string</span> <span class="methodname"><strong>openssl_encrypt</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$method</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$password</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$options</code><span class="initializer"> = 0</span></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$iv</code><span class="initializer"> = &quot;&quot;</span></span>
  ]] )</div>

  <p class="para rdfs-comment">
   Encrypts given data with given method and key, returns a raw
   or base64 encoded string
  </p>

  <div class="warning"><strong class="warning">Warning</strong><p class="simpara">本函数还未编写文档，仅有参数列表。</p></div>

 </div>


 <div class="refsect1 parameters" id="refsect1-function.openssl-encrypt-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">data</code></dt>

     <dd>

      <p class="para">
       The data.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">method</code></dt>

     <dd>

      <p class="para">
       The cipher method.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">password</code></dt>

     <dd>

      <p class="para">
       The password.
      </p>
     </dd>

    
    
      <dt>
<code class="parameter">options</code></dt>

      <dd>

        <p class="para">
          <code class="parameter">options</code> can be one of
          <strong><code>OPENSSL_RAW_DATA</code></strong>,
          <strong><code>OPENSSL_ZERO_PADDING</code></strong>.
        </p>
      </dd>

    
    
     <dt>
<code class="parameter">iv</code></dt>

     <dd>

      <p class="para">
       A non-NULL Initialization Vector.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.openssl-encrypt-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   Returns the encrypted string on success 或者在失败时返回 <strong><code>FALSE</code></strong>.
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-function.openssl-encrypt-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   Emits an <strong><code>E_WARNING</code></strong> level error if an unknown cipher
   algorithm is passed in via the <code class="parameter">method</code> parameter.
  </p>
  <p class="para">
   Emits an <strong><code>E_WARNING</code></strong> level error if an empty value is passed
   in via the <code class="parameter">iv</code> parameter.
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.openssl-encrypt-changelog">
  <h3 class="title">更新日志</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>版本</th>
      <th>说明</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>5.3.3</td>
      <td>
       The <code class="parameter">iv</code> parameter was added.
      </td>
     </tr>

     <tr>
      <td>5.4.0</td>
      <td>
       The <code class="parameter">raw_output</code> was changed to <code class="parameter">options</code>.
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 seealso" id="refsect1-function.openssl-encrypt-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.openssl-decrypt.html" class="function" rel="rdfs-seeAlso">openssl_decrypt()</a> - Decrypts data</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="116788""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#116788" class="date">28-Feb-2015 11:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a couple of notes about the parameters:<br />
<br />
data - It is interpreted as a binary string<br />
method - Regular string, make sure you check openssl_get_cipher_methods() for a list of the ciphers available in your server*<br />
password - As biohazard mentioned before, this is actually THE KEY! It should be in hex format.<br />
options - As explained in the Parameters section<br />
iv - Initialization Vector. Different than biohazard mentioned before, this should be a BINARY string. You should check for your particular implementation.<br />
<br />
To verify the length/format of your IV, you can provide strings of different lengths and check the error log. For example, in PHP 5.5.9 (Ubuntu 14.04 LTS), providing a 32 byte hex string (which would represent a 16 byte binary IV) throws an error.<br />
"IV passed is 32 bytes long which is longer than the 16 expected by the selected cipher" (cipher chosen was 'aes-256-cbc' which uses an IV of 128 bits, its block size). <br />
Alternatively, you can use openssl_cipher_iv_length().<br />
<br />
From the security standpoint, make sure you understand whether your IV needs to be random, secret or encrypted. Many times the IV can be non-secret but it has to be a cryptographically secure random number. Make sure you generate it with an appropriate function like openssl_random_pseudo_bytes(), not mt_rand().<br />
<br />
*Note that the available cipher methods can differ between your dev server and your production server! They will depend on the installation and compilation options used for OpenSSL in your machine(s).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="110047""></a>
  <div class="note">
   <strong class="user">kasper at webmasteren dot eu</strong>
   <a href="#110047" class="date">14-Sep-2012 08:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For security reasons, if NOT&nbsp; encrypting using a (cryptographically) random IV, then the IV itself must be entryptet as well ( this is not handled behind the scene). <br />
the reason is that it leads to predictable IV's, which then breaks semantic security. [this kind of attack can already be done on ssl/ TLS 1.1].</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109598""></a>
  <div class="note">
   <strong class="user">max</strong>
   <a href="#109598" class="date">01-Aug-2012 11:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Might be useful to people trying to use 'aes-256-cbc' cipher (and probably other cbc ciphers) in collaboration with other implementations of AES (C libs for example) that the openssl extension has a strict implementation regarding padding bytes. I found the solution only by manually going through the openssl source.<br />
<br />
In C, you would want to pad plaintexts the following way (assuming all mem allocations are proper):<br />
<br />
nPadding = ( 16 - ( bufferSize % 16 ) ) ? ( 16 - ( bufferSize % 16 ) ) : 16;<br />
for( index = bufferSize; index &lt; bufferSize + nPadding; index++ )<br />
{<br />
&nbsp;&nbsp;&nbsp; plaintext[ index ] = (char)nPadding;<br />
}<br />
<br />
while decryptions are validated like:<br />
<br />
isSuccess = TRUE;<br />
for( index = bufferSize - 1; index &gt; ( bufferSize - nPadding ); index-- )<br />
{<br />
&nbsp;&nbsp;&nbsp; if( plaintext[ index ] != nPadding )<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; isSuccess = FALSE;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
decryptedSize = bufferSize - nPadding;<br />
<br />
In plain english, the buffer must be padded up to blockSize. If the buffer is already a multiple of blockSize, you add an entire new blockSize bytes as padding.<br />
<br />
The value of the padding bytes MUST be the number of padding bytes as a byte...<br />
<br />
So 5 bytes of padding will result in the following bytes added at the end of the ciphertext:<br />
[ 0x05 ][ 0x05 ][ 0x05 ][ 0x05 ][ 0x05 ]<br />
<br />
Hope this saves someone else a few hours of their life.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109364""></a>
  <div class="note">
   <strong class="user">kazaaknet at yahoo dot com</strong>
   <a href="#109364" class="date">11-Jul-2012 02:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be advised there was a memory leak in this function: https://bugs.php.net/bug.php?id=54060.&nbsp; I believe this got fixed in 5.3.6, but on production webservers running 5.3.5 with modest traffic, this became&nbsp; a memory hemorrhage that brought my site down.&nbsp; Look at mcrypt_encrypt instead.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108733""></a>
  <div class="note">
   <strong class="user">Kukulkan</strong>
   <a href="#108733" class="date">22-May-2012 12:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP OpenSSL functions openssl_encrypt() and openssl_decrypt() seem to use PKCS5/7 style padding for all symmetric ciphers. Upon this, you can't use them to encrypt using null byte padding or to decrypt null byte padded data.<br />
<br />
The developers of the wrapper forgot the padding scheme flags... :(</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104438""></a>
  <div class="note">
   <strong class="user">biohazard dot ge at gmail dot com</strong>
   <a href="#104438" class="date">15-Jun-2011 03:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Many users give up with handilng problem when openssl command line tool cant decrypt php openssl encrypted file which is encrypted with openssl_encrypt function.<br />
<br />
For example how beginner is encrypting data:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$string </span><span class="keyword">= </span><span class="string">'It works ? Or not it works ?'</span><span class="keyword">;<br />
</span><span class="default">$pass </span><span class="keyword">= </span><span class="string">'1234'</span><span class="keyword">;<br />
</span><span class="default">$method </span><span class="keyword">= </span><span class="string">'aes128'</span><span class="keyword">;<br />
<br />
</span><span class="default">file_put_contents </span><span class="keyword">(</span><span class="string">'./file.encrypted'</span><span class="keyword">, </span><span class="default">openssl_encrypt </span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$method</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">));<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
And then how beginner is trying to decrypt data from command line:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -pass pass:123<br />
<br />
Or even if he/she determinates that openssl_encrypt output was base64 and tries:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -pass pass:123<br />
<br />
Or even if he determinates that base64 encoded file is represented in one line and tries:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -A -pass pass:123<br />
<br />
Or even if he determinates that IV is needed and adds some string iv as encryption function`s fourth parameter and than adds hex representation of iv as parameter in openssl command line :<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -pass pass:123 -iv -iv 31323334353637383132333435363738<br />
<br />
Or even if he determinates that aes-128 password must be 128 bits there fore 16 bytes and sets $pass = '1234567812345678' and tries:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -base64 -pass pass:1234567812345678 -iv -iv 31323334353637383132333435363738<br />
<br />
All these troubles will have no result in any case.<br />
<br />
BECAUSE THE PASSWORD PARAMETER DOCUMENTED HERE IS NOT THE PASSWORD.<br />
<br />
It means that the password parameter of the function is not the same string used as [-pass pass:] parameter with openssl cmd tool for file encryption decryption.<br />
<br />
IT IS THE KEY !<br />
<br />
And now how to correctly encrypt data with php openssl_encrypt and how to correctly decrypt it from openssl command line tool.<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">strtohex</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">) <br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$s</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">str_split</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">) as </span><span class="default">$c</span><span class="keyword">) </span><span class="default">$s</span><span class="keyword">.=</span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">"%02X"</span><span class="keyword">,</span><span class="default">ord</span><span class="keyword">(</span><span class="default">$c</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return(</span><span class="default">$s</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$source </span><span class="keyword">= </span><span class="string">'It works !'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$iv </span><span class="keyword">= </span><span class="string">"1234567812345678"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pass </span><span class="keyword">= </span><span class="string">'1234567812345678'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$method </span><span class="keyword">= </span><span class="string">'aes-128-cbc'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\niv in hex to use: "</span><span class="keyword">.</span><span class="default">strtohex </span><span class="keyword">(</span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\nkey in hex to use: "</span><span class="keyword">.</span><span class="default">strtohex </span><span class="keyword">(</span><span class="default">$pass</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents </span><span class="keyword">(</span><span class="string">'./file.encrypted'</span><span class="keyword">,</span><span class="default">openssl_encrypt </span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">, </span><span class="default">$method</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$exec </span><span class="keyword">= </span><span class="string">"openssl enc -"</span><span class="keyword">.</span><span class="default">$method</span><span class="keyword">.</span><span class="string">" -d -in file.encrypted -nosalt -nopad -K "</span><span class="keyword">.</span><span class="default">strtohex</span><span class="keyword">(</span><span class="default">$pass</span><span class="keyword">).</span><span class="string">" -iv "</span><span class="keyword">.</span><span class="default">strtohex</span><span class="keyword">(</span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'executing: '</span><span class="keyword">.</span><span class="default">$exec</span><span class="keyword">.</span><span class="string">"\n\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">exec </span><span class="keyword">(</span><span class="default">$exec</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
IV and Key parameteres passed to openssl command line must be in hex representation of string.<br />
<br />
The correct command for decrypting is:<br />
<br />
# openssl enc -aes-128-cbc -d -in file.encrypted -nosalt -nopad -K 31323334353637383132333435363738 -iv 31323334353637383132333435363738<br />
<br />
As it has no salt has no padding and by setting functions third parameter we have no more base64 encoded file to decode. The command will echo that it works...<br />
<br />
: /</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99188""></a>
  <div class="note">
   <strong class="user">public at grik dot net</strong>
   <a href="#99188" class="date">02-Aug-2010 02:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In 5.3.3 they added a new parameter, string $iv (initialization vector)<br />
Real parameters are:<br />
string openssl_encrypt ( string $data , string $method , string $password, bool $raw_output = false, string $iv )<br />
<br />
If $iv is missing, a warning is issued: "Using an empty Initialization Vector (iv) is potentially insecure and not recommended".<br />
<br />
If $iv is too short, another warning: <br />
"IV passed is only 3 bytes long, cipher expects an IV of precisely 8 bytes, padding with \0"<br />
<br />
same IV should be used in openssl_decrypt()</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95306""></a>
  <div class="note">
   <strong class="user">public at grik dot net</strong>
   <a href="#95306" class="date">25-Dec-2009 06:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The list of methods for this function can be obtained with openssl_get_cipher_methods();<br />
The password can be encrypted with the openssl_private/public_encrypt()</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
