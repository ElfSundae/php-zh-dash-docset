<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>Session Handling</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.msession-unlock.html">? msession_unlock</a></li>
      <li style="float: right;"><a href="intro.session.html">简介 ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="refs.basic.session.html">Session 扩展</a></li>
    <li>Session Handling</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="book.session" class="book">
 
 <h1 class="title">Session Handling</h1>
 

 
 
 

 







 

 








 









 







 








 









 






 







<ul class="chunklist chunklist_book"><li><a href="intro.session.html">简介</a></li><li><a href="session.setup.html">安装／配置</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="session.requirements.html">需求</a></li><li><a href="session.installation.html">安装</a></li><li><a href="session.configuration.html">运行时配置</a></li><li><a href="session.resources.html">资源类型</a></li></ul></li><li><a href="session.constants.html">预定义常量</a></li><li><a href="session.examples.html">范例</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="session.examples.basic.html">基本用法</a></li><li><a href="session.idpassing.html">传送会话ID</a></li><li><a href="session.customhandler.html">自定义会话管理器</a></li></ul></li><li><a href="session.upload-progress.html">Session Upload Progress</a></li><li><a href="session.security.html">会话和安全</a></li><li><a href="ref.session.html">Session 函数</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="function.session-abort.html">session_abort</a> &mdash; Discard session array changes and finish session</li><li><a href="function.session-cache-expire.html">session_cache_expire</a> &mdash; 返回当前缓存的到期时间</li><li><a href="function.session-cache-limiter.html">session_cache_limiter</a> &mdash; 读取/设置缓存限制器</li><li><a href="function.session-commit.html">session_commit</a> &mdash; session_write_close 的别名</li><li><a href="function.session-decode.html">session_decode</a> &mdash; 解码会话数据</li><li><a href="function.session-destroy.html">session_destroy</a> &mdash; 销毁一个会话中的全部数据</li><li><a href="function.session-encode.html">session_encode</a> &mdash; 将当前会话数据编码为一个字符串</li><li><a href="function.session-get-cookie-params.html">session_get_cookie_params</a> &mdash; 获取会话 cookie 参数</li><li><a href="function.session-id.html">session_id</a> &mdash; 获取/设置当前会话 ID</li><li><a href="function.session-is-registered.html">session_is_registered</a> &mdash; 检查变量是否在会话中已经注册</li><li><a href="function.session-module-name.html">session_module_name</a> &mdash; 获取/设置会话模块名称</li><li><a href="function.session-name.html">session_name</a> &mdash; 读取/设置会话名称</li><li><a href="function.session-regenerate-id.html">session_regenerate_id</a> &mdash; 使用新生成的会话 ID 更新现有会话 ID</li><li><a href="function.session-register-shutdown.html">session_register_shutdown</a> &mdash; 关闭会话</li><li><a href="function.session-register.html">session_register</a> &mdash; Register one or more global variables with the current session</li><li><a href="function.session-reset.html">session_reset</a> &mdash; Re-initialize session array with original values</li><li><a href="function.session-save-path.html">session_save_path</a> &mdash; 读取/设置当前会话的保存路径</li><li><a href="function.session-set-cookie-params.html">session_set_cookie_params</a> &mdash; 设置会话 cookie 参数</li><li><a href="function.session-set-save-handler.html">session_set_save_handler</a> &mdash; 设置用户自定义会话存储函数</li><li><a href="function.session-start.html">session_start</a> &mdash; 启动新会话或者重用现有会话</li><li><a href="function.session-status.html">session_status</a> &mdash; Returns the current session status</li><li><a href="function.session-unregister.html">session_unregister</a> &mdash; Unregister a global variable from the current session</li><li><a href="function.session-unset.html">session_unset</a> &mdash; Free all session variables</li><li><a href="function.session-write-close.html">session_write_close</a> &mdash; Write session data and end session</li></ul></li><li><a href="class.sessionhandler.html">SessionHandler</a> &mdash; The SessionHandler class<ul class="chunklist chunklist_book chunklist_children"><li><a href="sessionhandler.close.html">SessionHandler::close</a> &mdash; Close the session</li><li><a href="sessionhandler.create-sid.html">SessionHandler::create_sid</a> &mdash; Return a new session ID</li><li><a href="sessionhandler.destroy.html">SessionHandler::destroy</a> &mdash; Destroy a session</li><li><a href="sessionhandler.gc.html">SessionHandler::gc</a> &mdash; Cleanup old sessions</li><li><a href="sessionhandler.open.html">SessionHandler::open</a> &mdash; Initialize session</li><li><a href="sessionhandler.read.html">SessionHandler::read</a> &mdash; Read session data</li><li><a href="sessionhandler.write.html">SessionHandler::write</a> &mdash; Write session data</li></ul></li><li><a href="class.sessionhandlerinterface.html">SessionHandlerInterface</a> &mdash; The SessionHandlerInterface class<ul class="chunklist chunklist_book chunklist_children"><li><a href="sessionhandlerinterface.close.html">SessionHandlerInterface::close</a> &mdash; Close the session</li><li><a href="sessionhandlerinterface.destroy.html">SessionHandlerInterface::destroy</a> &mdash; Destroy a session</li><li><a href="sessionhandlerinterface.gc.html">SessionHandlerInterface::gc</a> &mdash; Cleanup old sessions</li><li><a href="sessionhandlerinterface.open.html">SessionHandlerInterface::open</a> &mdash; Initialize session</li><li><a href="sessionhandlerinterface.read.html">SessionHandlerInterface::read</a> &mdash; Read session data</li><li><a href="sessionhandlerinterface.write.html">SessionHandlerInterface::write</a> &mdash; Write session data</li></ul></li></ul></div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="116217""></a>
  <div class="note">
   <strong class="user">bouvrette dot nicolas at gmail dot com</strong>
   <a href="#116217" class="date">24-Nov-2014 06:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful if you are updating to PHP 5.6 since the the Sessions's Write behavior changed.&nbsp; It now only writes the session if you changed the data. So this means that if you rely on your session to update an activity time stamp on the server (to control session expiry) you will end up having issues. Here is a quick fix if you are implementing SessionHandlerInterface:<br />
<br />
&nbsp;&nbsp;&nbsp; public function close() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;write($this-&gt;id, serialize($_SESSION));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return true;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
Make sure you also use this:<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; ini_set('session.serialize_handler', 'php_serialize'); // Force standard PHP functions handler for flexibility<br />
<br />
More details here:<br />
<br />
Request #17860 (Session write short circuit)<br />
https://bugs.php.net/bug.php?id=17860</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103020""></a>
  <div class="note">
   <strong class="user">roberto at spadim dot com dot br</strong>
   <a href="#103020" class="date">21-Mar-2011 07:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
instead of memcache, you should consider using redis<br />
<a href="http://redis.io/commands" rel="nofollow" target="_blank">http://redis.io/commands</a><br />
<br />
it have KEYS command (<a href="http://redis.io/commands/keys" rel="nofollow" target="_blank">http://redis.io/commands/keys</a>) that can return all keys (like 'ls'/'dir' at php sessions directory)<br />
<br />
it allow replication too (cluster use)<br />
<br />
i don't know if anyone wrote a version of phpsessions using redis yet, but since memcache don't have KEYS command, it's hard to know if the users is connected (at app side) or what sessions still active (not expired/not logged)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102685""></a>
  <div class="note">
   <strong class="user">elephant at punx dot pl</strong>
   <a href="#102685" class="date">28-Feb-2011 08:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note, that database is NOT recommended for session storage. It can be a big performance bottleneck, especially in replicated environments.<br />
<br />
For saving sessions, file handler seems to be very effective for most setups, except those situations:<br />
&nbsp;- if performance is an issue, the directory which stores session files can be mounted as tmpfs (ram disk).<br />
&nbsp;- if sharing sessions across multiple webservers is needed (in clustered environments), use memcache for storing session information (tip: you can setup more than one instance of memcache eliminate single point of failure). This method, however, sets a limitation of session size to 64k (this should be enough for most applications)<br />
&nbsp;- don't use NFS for sharing session files between webservers, it does not handle locking correctly and can cause corruption of session data.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90351""></a>
  <div class="note">
   <strong class="user">e dot mortoray at ecircle dot com</strong>
   <a href="#90351" class="date">17-Apr-2009 02:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There is a nuance we found with session timing out although the user is still active in the session.&nbsp; The problem has to do with never modifying the session variable.
<br />

<br />
The GC will clear the session data files based on their last modification time.&nbsp; Thus if you never modify the session, you simply read from it, then the GC will eventually clean up.
<br />

<br />
To prevent this you need to ensure that your session is modified within the GC delete time.&nbsp; You can accomplish this like below.
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">if( !isset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'last_access'</span><span class="keyword">]) || (</span><span class="default">time</span><span class="keyword">() - </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'last_access'</span><span class="keyword">]) &gt; </span><span class="default">60 </span><span class="keyword">)
<br />
&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'last_access'</span><span class="keyword">] = </span><span class="default">time</span><span class="keyword">();
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
This will update the session every 60s to ensure that the modification date is altered.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88230""></a>
  <div class="note">
   <strong class="user">Some Guy</strong>
   <a href="#88230" class="date">16-Jan-2009 01:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just some notes - it seems that php does the session writing after the script exits.<br />
For example, if you set a bunch of session variables and then run session_regenerate_id() - the session variables are never written to the old session. The new session id is generated when you ask it to be generated, but the session exists only in memory until after the script exits - when the session is written and any and all session variables are written to it.<br />
<br />
This caused me some confusion, as I'm running sessions in an sql database rather than flat file, trying to do any manipulation of the session database directly in a script where you have run session_regenerate_id() will fail for the new session ID because the insert hasn't been done yet, and setting any session variables will only be written to the new session, even if set before you regenerate the session ID.<br />
<br />
Also - if using a database for sessions, make sure to use mysql_real_escape_string() before saving any session variables.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84753""></a>
  <div class="note">
   <strong class="user">Madster</strong>
   <a href="#84753" class="date">28-Jul-2008 09:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When you include a php file in your current script it's included, not processed separately, thus it's still within the same page and the current page hasn't finished processing.<br />
Thus, session is not set yet. This is the expected behaviour.<br />
<br />
If you need to load a page after setting session data, you should set session data and then send a redirection or refresh header (remember not to send anything, not even whitespace before sending headers).<br />
<br />
Always consider session data to be updated after the next page load (as in http request completed).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
