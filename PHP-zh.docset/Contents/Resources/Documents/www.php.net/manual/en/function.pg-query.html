<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>执行查询</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.pg-query-params.html">? pg_query_params</a></li>
      <li style="float: right;"><a href="function.pg-result-error-field.html">pg_result_error_field ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.pgsql.html">PostgreSQL 函数</a></li>
    <li>执行查询</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.pg-query" class="refentry">
   <div class="refnamediv">
    <h1 class="refname">pg_query</h1>
    <p class="verinfo">(PHP 4 &gt;= 4.2.0, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">pg_query</span> &mdash; <span class="dc-title">执行查询</span></p>

   </div>
   <div class="refsect1 unknown-seealsp" id="refsect1-function.pg-query-unknown-seealsp">
    <h3 class="title">说明</h3>
     <div class="methodsynopsis dc-description">
      <span class="methodname"><strong>pg_query</strong></span>(<span class="methodparam"><span class="type">resource</span> <code class="parameter">$connection</code></span>, <span class="methodparam"><span class="type">string</span> <code class="parameter">$query</code></span>): <span class="type">resource</span></div>

    <p class="para rdfs-comment">
     <span class="function"><strong>pg_query()</strong></span>
     在查询可以执行时返回查询结果资源号。如果查询失败或者提供的连接号无效则返回
     <strong><code>false</code></strong>。如果连接号有效，则可以用 <span class="function"><a href="function.pg-last-error.html" class="function">pg_last_error()</a></span>
     函数来提取详细的错误信息。<span class="function"><strong>pg_query()</strong></span>
     发送一条 SQL 语句到 <code class="parameter">connection</code>
     资源指定的 PostgreSQL 数据库。<code class="parameter">connection</code>
     必须是由 <span class="function"><a href="function.pg-connect.html" class="function">pg_connect()</a></span> 或 <span class="function"><a href="function.pg-pconnect.html" class="function">pg_pconnect()</a></span>
     返回的合法连接号。本函数返回值是一个其它 PostgreSQL 函数例如
     <span class="function"><a href="function.pg-fetch-array.html" class="function">pg_fetch_array()</a></span> 可以用来访问查询结果的查询结果资源号。
     <blockquote class="note"><p><strong class="note">Note</strong>: 
      <span class="simpara">
       <code class="parameter">connection</code> 是 <span class="function"><strong>pg_query()</strong></span>
       中的可选参数。如果没有指定
       <code class="parameter">connection</code>，则使用默认连接。默认连接是
       <span class="function"><a href="function.pg-connect.html" class="function">pg_connect()</a></span> 或 <span class="function"><a href="function.pg-pconnect.html" class="function">pg_pconnect()</a></span>
       所打开的最后一个连接。
      </span>
      <span class="simpara">
       尽管 <code class="parameter">connection</code>
       参数可以省略，但不推荐这样做。因为这样可能会导致很难发现脚本中的错误。
      </span>
     </p></blockquote>
    </p>
    <blockquote class="note"><p><strong class="note">Note</strong>: 
     <p class="para">
      本函数以前的名字为 <code class="literal">pg_exec()</code>。<code class="literal">pg_exec()</code>
      函数为了兼容性的原因仍然可以使用，但是鼓励用户使用新的名字。
     </p>
    </p></blockquote>
    <p class="para">
     参见 <span class="function"><a href="function.pg-connect.html" class="function">pg_connect()</a></span>，<span class="function"><a href="function.pg-pconnect.html" class="function">pg_pconnect()</a></span>，<span class="function"><a href="function.pg-fetch-array.html" class="function">pg_fetch_array()</a></span>，<span class="function"><a href="function.pg-fetch-object.html" class="function">pg_fetch_object()</a></span>，<span class="function"><a href="function.pg-num-rows.html" class="function">pg_num_rows()</a></span>
     和 <span class="function"><a href="function.pg-affected-rows.html" class="function">pg_affected_rows()</a></span>。
    </p>
   </div>

  </div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="113922""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#113922" class="date">17-Dec-2013 10:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is my small function to make it easier for me to use data from select queries (attention, it is sensitive to sql injection)<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">requestToDB</span><span class="keyword">(</span><span class="default">$connection</span><span class="keyword">,</span><span class="default">$request</span><span class="keyword">){ <br />
&nbsp;&nbsp;&nbsp; if(!</span><span class="default">$result</span><span class="keyword">=</span><span class="default">pg_query</span><span class="keyword">(</span><span class="default">$connection</span><span class="keyword">,</span><span class="default">$request</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">False</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$combined</span><span class="keyword">=array();<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$combined</span><span class="keyword">[]=</span><span class="default">$row</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$combined</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Example:<br />
<span class="default">&lt;?php<br />
$conn </span><span class="keyword">= </span><span class="default">pg_pconnect</span><span class="keyword">(</span><span class="string">"dbname=mydatabase"</span><span class="keyword">);<br />
<br />
</span><span class="default">$results</span><span class="keyword">=</span><span class="default">requestToDB</span><span class="keyword">(</span><span class="default">$connect</span><span class="keyword">,</span><span class="string">"select * from mytable"</span><span class="keyword">);<br />
<br />
</span><span class="comment">//You can now access a "cell" of your table like this:<br />
</span><span class="default">$rownumber</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
</span><span class="default">$columname</span><span class="keyword">=</span><span class="string">"mycolumn"</span><span class="keyword">;<br />
<br />
</span><span class="default">$mycell</span><span class="keyword">=</span><span class="default">$results</span><span class="keyword">[</span><span class="default">$rownumber</span><span class="keyword">][</span><span class="default">$columname</span><span class="keyword">];<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$mycell</span><span class="keyword">);</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112220""></a>
  <div class="note">
   <strong class="user">a dot mcruer at live dot com</strong>
   <a href="#112220" class="date">17-May-2013 06:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A quick note for novice users: when gathering input from fields on a web form that maintains a database connection, *never* use pg_query to do queries from the field. Always sanitize input using pg_prepare and pg_execute.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69675""></a>
  <div class="note">
   <strong class="user">sd at dicksonlife dot com</strong>
   <a href="#69675" class="date">14-Sep-2006 12:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Took me a while to track this down so I thought it might be useful for others:<br />
<br />
If you use stored procedures and need to get result sets back from them:<br />
<br />
function dbquery($link,$query){<br />
&nbsp; pg_query($link,"BEGIN;");<br />
&nbsp; $tr=pg_query($link,$query);<br />
&nbsp; $r=pg_fetch_row($tr);<br />
&nbsp; $name=$r[0];<br />
&nbsp; $rs=pg_query($link,"FETCH ALL IN \"" . $name . "\";");<br />
&nbsp; pg_query($link,"END;");<br />
&nbsp; return $rs;<br />
}<br />
<br />
(Error checking removed for clarity)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66408""></a>
  <div class="note">
   <strong class="user">zoli at makettinfo.hu</strong>
   <a href="#66408" class="date">21-May-2006 08:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It would be better this way:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $result</span><span class="keyword">=</span><span class="default">pg_query</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="string">"SELECT COUNT(*) AS rows FROM x WHERE a=b;"</span><span class="keyword">);<br />
&nbsp; if&nbsp; (!</span><span class="default">$result</span><span class="keyword">) {<br />
&nbsp;&nbsp; echo </span><span class="string">"query did not execute"</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; if (</span><span class="default">$line </span><span class="keyword">= </span><span class="default">pg_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$line</span><span class="keyword">[</span><span class="string">'rows'</span><span class="keyword">] == </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; echo </span><span class="string">"0 records"<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp; }<br />
&nbsp; else {<br />
&nbsp;&nbsp; while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_array</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">//do stuff with $row<br />
&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span> <br />
<br />
This solution doesn't raise the load of the system with the move of matching rows (perhaps 0,1, perhaps 100, 1000, ... rows)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66055""></a>
  <div class="note">
   <strong class="user">mankyd</strong>
   <a href="#66055" class="date">13-May-2006 07:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There was a typo in the code that I posted:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $result</span><span class="keyword">=</span><span class="default">pg_query</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="string">"SELECT * FROM x WHERE a=b;"</span><span class="keyword">);<br />
&nbsp; if&nbsp; (!</span><span class="default">$result</span><span class="keyword">) {<br />
&nbsp;&nbsp; echo </span><span class="string">"query did not execute"</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; if (</span><span class="default">pg_num_rows</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">) == </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; echo </span><span class="string">"0 records"<br />
&nbsp; </span><span class="keyword">}<br />
&nbsp; else {<br />
&nbsp;&nbsp; while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_array</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">//do stuff with $row<br />
&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66040""></a>
  <div class="note">
   <strong class="user">mankyd</strong>
   <a href="#66040" class="date">12-May-2006 06:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Improving upon what jsuzuki said:<br />
<br />
It's probably better to use pg_num_rows() to see if no rows were returned, as that leaves the resultset cursor pointed to the first row so you can use it in a loop.<br />
<br />
Example:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $result</span><span class="keyword">=</span><span class="default">pg_query</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="string">"SELECT * FROM x WHERE a=b;"</span><span class="keyword">);<br />
&nbsp; if&nbsp; (!</span><span class="default">$result</span><span class="keyword">) {<br />
&nbsp;&nbsp; echo </span><span class="string">"query did not execute"</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; if (</span><span class="default">pg_num_rows</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">) == </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; echo </span><span class="string">"0 records"<br />
&nbsp; </span><span class="keyword">}<br />
&nbsp; else {<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_array</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">//do stuff with $row<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
I, personally, also find it more readable.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59143""></a>
  <div class="note">
   <strong class="user">jsuzuki at spamcop dot net</strong>
   <a href="#59143" class="date">27-Nov-2005 05:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
expanding on the note left by "cmoore" -<br />
<br />
To check to see if the recordset returned no records,<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; $result</span><span class="keyword">=</span><span class="default">pg_query</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="string">"SELECT * FROM x WHERE a=b;"</span><span class="keyword">);<br />
&nbsp; if&nbsp; (!</span><span class="default">$result</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"query did not execute"</span><span class="keyword">;<br />
&nbsp; }<br />
&nbsp; </span><span class="default">$rs </span><span class="keyword">= </span><span class="default">pg_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">);<br />
&nbsp; if (!</span><span class="default">$rs</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"0 records"<br />
&nbsp; </span><span class="keyword">}<br />
</span><span class="default">?&gt;<br />
</span><br />
-jack</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56506""></a>
  <div class="note">
   <strong class="user">cmoore</strong>
   <a href="#56506" class="date">05-Sep-2005 11:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
One thing to note that wasn't obvious to me at first.&nbsp; If your query returns zero rows, that is not a "failed" query.&nbsp; So the following is wrong:<br />
&nbsp; $result=pg_query($conn, "SELECT * FROM x WHERE a=b;");<br />
&nbsp; if&nbsp; (!$result) {<br />
&nbsp;&nbsp;&nbsp; echo "No a=b in x\n";<br />
&nbsp; }<br />
<br />
pg_query returns FALSE if the query can not be executed for some reason.&nbsp; If the query is executed but returns zero rows then you get back a resul with no rows.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47818""></a>
  <div class="note">
   <strong class="user">Akbar</strong>
   <a href="#47818" class="date">01-Dec-2004 08:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Use pg_query to call your stored procedures, and use pg_fetch_result when getting a value (like a smallint as in this example) returned by your stored procedure.<br />
<br />
<span class="default">&lt;?php<br />
$pgConnection </span><span class="keyword">= </span><span class="default">pg_connect</span><span class="keyword">(</span><span class="string">"dbname=users user=me"</span><span class="keyword">);<br />
<br />
</span><span class="default">$userNameToCheckFor </span><span class="keyword">= </span><span class="string">"metal"</span><span class="keyword">;<br />
<br />
</span><span class="default">$result </span><span class="keyword">= </span><span class="default">pg_query</span><span class="keyword">(</span><span class="default">$pgConnection</span><span class="keyword">, </span><span class="string">"SELECT howManyUsersHaveThisName('</span><span class="default">$userNameToCheckFor</span><span class="string">')"</span><span class="keyword">);<br />
<br />
</span><span class="default">$count </span><span class="keyword">= </span><span class="default">pg_fetch_result</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="string">'howManyUsersHaveThisName'</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25981""></a>
  <div class="note">
   <strong class="user">mentat at azsoft dot pl</strong>
   <a href="#25981" class="date">14-Oct-2002 05:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
$GLOBALS["PG_CONNECT"]=pg_connect(...);<br />
....<br />
<br />
function query ($sqlQuery,$var=0) {<br />
&nbsp;&nbsp; if (!$GLOBALS["PG_CONNECT"]) return 0;<br />
&nbsp;&nbsp; $lev=error_reporting (8); //NO WARRING!!<br />
&nbsp;&nbsp; $result=pg_query ($sqlQuery);<br />
&nbsp;&nbsp; error_reporting ($lev); //DEFAULT!!<br />
&nbsp;&nbsp; if (strlen ($r=pg_last_error ($GLOBALS["PG_CONNECT"]))) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; if ($var) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo "&lt;p color=\"red\"&gt;ERROR:&lt;pre&gt;";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo $sqlQuery;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo "&lt;/pre&gt;";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo $r;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo "&amp;lt/p&gt;";<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; close_db ();<br />
&nbsp;&nbsp; &nbsp;&nbsp; return 0;<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; return $result;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
