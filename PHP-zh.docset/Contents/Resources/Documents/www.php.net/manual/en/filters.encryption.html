<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>加密过滤器</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/46435ff017f60abb4908b0ce55102d08-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/46435ff017f60abb4908b0ce55102d08-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="filters.compression.html">? 压缩过滤器</a></li>
      <li style="float: right;"><a href="transports.html">所支持的套接字传输器列表 ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="filters.html">可用过滤器列表</a></li>
    <li>加密过滤器</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="filters.encryption" class="section">
    <h2 class="title">加密过滤器</h2>

   <p class="para">
    加密过滤器特别适用于文件/数据流的加密。
   </p>

 <div class="section" id="filters.encryption.mcrypt">
  <h2 class="title">mcrypt.* 和 mdecrypt.*</h2>
  <p class="para">
   <div class="warning"><strong class="warning">Warning</strong><p class="simpara">本特性已自 PHP 7.1.0
起<em class="emphasis">废弃</em>。强烈建议不要使用本特性。</p></div>
  </p>

    <p class="simpara">
     <code class="literal">mcrypt.*</code> 和
     <code class="literal">mdecrypt.*</code> 使用 libmcrypt 提供了对称的加密和解密。这两组过滤器都支持
    <a href="ref.mcrypt.html" class="link">mcrypt 扩展库</a>中相同的算法，格式为 
    <code class="literal">mcrypt.ciphername</code>，其中 
    <code class="parameter">ciphername</code> 是密码的名字，将被传递给 
    <span class="function"><a href="function.mcrypt-module-open.html" class="function">mcrypt_module_open()</a></span>。有以下五个过滤器参数可用：
    </p>

    <p class="para">
      <table class="doctable table">
        <caption><strong>mcrypt 过滤器参数</strong></caption>
        
          <thead>
            <tr>
              <th>参数</th>
              <th>是否必须</th>
              <th>默认值</th>
              <th>取值举例</th>
            </tr>

          </thead>

          <tbody class="tbody">
            <tr>
              <td>mode</td>
              <td>可选</td>
              <td>cbc</td>
              <td>cbc, cfb, ecb, nofb, ofb, stream</td>
            </tr>

            <tr>
              <td>algorithms_dir</td>
              <td>可选</td>
              <td>ini_get(&#039;mcrypt.algorithms_dir&#039;)</td>
              <td>algorithms 模块的目录</td>
            </tr>

            <tr>
              <td>modes_dir</td>
              <td>可选</td>
              <td>ini_get(&#039;mcrypt.modes_dir&#039;)</td>
              <td>modes 模块的目录</td>
            </tr>

            <tr>
              <td>iv</td>
              <td>必须</td>
              <td>N/A</td>
              <td>典型为 8，16 或 32 字节的二进制数据。根据密码而定</td>
            </tr>

            <tr>
              <td>key</td>
              <td>必须</td>
              <td>N/A</td>
              <td>典型为 8，16 或 32 字节的二进制数据。根据密码而定</td>
            </tr>

          </tbody>
        
      </table>

    </p>

  <div class="example" id="">
   <p><strong>Example #1 用 Blowfish 算法加解密</strong></p>
   <div class="example-contents">
    <div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">// 假设之前已经生成了 $key<br /></span><span style="color: #0000BB">$iv_size </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_get_iv_size</span><span style="color: #007700">(</span><span style="color: #0000BB">MCRYPT_BLOWFISH</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_MODE_CBC</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$iv </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_create_iv</span><span style="color: #007700">(</span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_DEV_URANDOM</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$fp </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'encrypted-file.enc'</span><span style="color: #007700">, </span><span style="color: #DD0000">'wb'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$opts </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'mode'</span><span style="color: #007700">=&gt;</span><span style="color: #DD0000">'cbc'</span><span style="color: #007700">,</span><span style="color: #DD0000">'iv'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">, </span><span style="color: #DD0000">'key'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$key</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">stream_filter_append</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #DD0000">'mcrypt.blowfish'</span><span style="color: #007700">, </span><span style="color: #0000BB">STREAM_FILTER_WRITE</span><span style="color: #007700">, </span><span style="color: #0000BB">$opts</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #DD0000">'message to encrypt'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">// 解密<br /></span><span style="color: #0000BB">$fp </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'encrypted-file.enc'</span><span style="color: #007700">, </span><span style="color: #DD0000">'rb'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$iv </span><span style="color: #007700">= </span><span style="color: #0000BB">fread</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv_size </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_get_iv_size</span><span style="color: #007700">(</span><span style="color: #0000BB">MCRYPT_BLOWFISH</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_MODE_CBC</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">$opts </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'mode'</span><span style="color: #007700">=&gt;</span><span style="color: #DD0000">'cbc'</span><span style="color: #007700">,</span><span style="color: #DD0000">'iv'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">, </span><span style="color: #DD0000">'key'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$key</span><span style="color: #007700">)<br /></span><span style="color: #0000BB">stream_filter_append</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">, </span><span style="color: #DD0000">'mdecrypt.blowfish'</span><span style="color: #007700">, </span><span style="color: #0000BB">STREAM_FILTER_READ</span><span style="color: #007700">, </span><span style="color: #0000BB">$opts</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$data </span><span style="color: #007700">= </span><span style="color: #0000BB">rtrim</span><span style="color: #007700">(</span><span style="color: #0000BB">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">));</span><span style="color: #FF8000">//trims off null padding<br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br />echo </span><span style="color: #0000BB">$data</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>

    <div class="example" id="">
      <p><strong>Example #2 将文件以 SHA256 HMAC 的 AES-128 CBC 加密</strong></p>
     <div class="example-contents">
      <div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />AES_CBC</span><span style="color: #007700">::</span><span style="color: #0000BB">encryptFile</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #DD0000">"plaintext.txt"</span><span style="color: #007700">, </span><span style="color: #DD0000">"encrypted.enc"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">AES_CBC</span><span style="color: #007700">::</span><span style="color: #0000BB">decryptFile</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #DD0000">"encrypted.enc"</span><span style="color: #007700">, </span><span style="color: #DD0000">"decrypted.txt"</span><span style="color: #007700">);<br /><br />class </span><span style="color: #0000BB">AES_CBC<br /></span><span style="color: #007700">{<br />   protected static </span><span style="color: #0000BB">$KEY_SIZES </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'AES-128'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">16</span><span style="color: #007700">,</span><span style="color: #DD0000">'AES-192'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">24</span><span style="color: #007700">,</span><span style="color: #DD0000">'AES-256'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">32</span><span style="color: #007700">);<br />   protected static function </span><span style="color: #0000BB">key_size</span><span style="color: #007700">() { return </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">$KEY_SIZES</span><span style="color: #007700">[</span><span style="color: #DD0000">'AES-128'</span><span style="color: #007700">]; } </span><span style="color: #FF8000">//default AES-128<br />   </span><span style="color: #007700">public static function </span><span style="color: #0000BB">encryptFile</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$input_stream</span><span style="color: #007700">, </span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">){<br />      </span><span style="color: #0000BB">$iv_size </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_get_iv_size</span><span style="color: #007700">(</span><span style="color: #0000BB">MCRYPT_RIJNDAEL_128</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_MODE_CBC</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$fin </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #0000BB">$input_stream</span><span style="color: #007700">, </span><span style="color: #DD0000">"rb"</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$fc </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">, </span><span style="color: #DD0000">"wb+"</span><span style="color: #007700">);<br />      if (!empty(</span><span style="color: #0000BB">$fin</span><span style="color: #007700">) &amp;&amp; !empty(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">)) {<br />         </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"_"</span><span style="color: #007700">, </span><span style="color: #0000BB">32</span><span style="color: #007700">) );</span><span style="color: #FF8000">//placeholder, SHA256 HMAC will go here later<br />         </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">$hmac_salt </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_create_iv</span><span style="color: #007700">(</span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_DEV_URANDOM</span><span style="color: #007700">));<br />         </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">$esalt </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_create_iv</span><span style="color: #007700">(</span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_DEV_URANDOM</span><span style="color: #007700">));<br />         </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_create_iv</span><span style="color: #007700">(</span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_DEV_URANDOM</span><span style="color: #007700">));<br />         </span><span style="color: #0000BB">$ekey </span><span style="color: #007700">= </span><span style="color: #0000BB">hash_pbkdf2</span><span style="color: #007700">(</span><span style="color: #DD0000">"sha256"</span><span style="color: #007700">, </span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$esalt</span><span style="color: #007700">, </span><span style="color: #0000BB">$it</span><span style="color: #007700">=</span><span style="color: #0000BB">1000</span><span style="color: #007700">, </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">key_size</span><span style="color: #007700">(), </span><span style="color: #0000BB">$raw</span><span style="color: #007700">=</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$opts </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'mode'</span><span style="color: #007700">=&gt;</span><span style="color: #DD0000">'cbc'</span><span style="color: #007700">, </span><span style="color: #DD0000">'iv'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">, </span><span style="color: #DD0000">'key'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$ekey</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">stream_filter_append</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #DD0000">'mcrypt.rijndael-128'</span><span style="color: #007700">, </span><span style="color: #0000BB">STREAM_FILTER_WRITE</span><span style="color: #007700">, </span><span style="color: #0000BB">$opts</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$infilesize </span><span style="color: #007700">= </span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />         while (!</span><span style="color: #0000BB">feof</span><span style="color: #007700">(</span><span style="color: #0000BB">$fin</span><span style="color: #007700">)) {<br />            </span><span style="color: #0000BB">$block </span><span style="color: #007700">= </span><span style="color: #0000BB">fread</span><span style="color: #007700">(</span><span style="color: #0000BB">$fin</span><span style="color: #007700">, </span><span style="color: #0000BB">8192</span><span style="color: #007700">);<br />            </span><span style="color: #0000BB">$infilesize</span><span style="color: #007700">+=</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$block</span><span style="color: #007700">);<br />            </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">$block</span><span style="color: #007700">);<br />         }<br />         </span><span style="color: #0000BB">$block_size </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_get_block_size</span><span style="color: #007700">(</span><span style="color: #0000BB">MCRYPT_RIJNDAEL_128</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_MODE_CBC</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$padding </span><span style="color: #007700">= </span><span style="color: #0000BB">$block_size </span><span style="color: #007700">- (</span><span style="color: #0000BB">$infilesize </span><span style="color: #007700">% </span><span style="color: #0000BB">$block_size</span><span style="color: #007700">);</span><span style="color: #FF8000">//$padding is a number from 1-16<br />         </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #0000BB">chr</span><span style="color: #007700">(</span><span style="color: #0000BB">$padding</span><span style="color: #007700">), </span><span style="color: #0000BB">$padding</span><span style="color: #007700">) );</span><span style="color: #FF8000">//perform PKCS7 padding<br />         </span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fin</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$hmac_raw </span><span style="color: #007700">= </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">calculate_hmac_after_32bytes</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$hmac_salt</span><span style="color: #007700">, </span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$fc </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">, </span><span style="color: #DD0000">"rb+"</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">$hmac_raw</span><span style="color: #007700">);</span><span style="color: #FF8000">//overwrite placeholder<br />         </span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">);<br />      }<br />   }<br />   public static function </span><span style="color: #0000BB">decryptFile</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">, </span><span style="color: #0000BB">$out_stream</span><span style="color: #007700">) {<br />      </span><span style="color: #0000BB">$iv_size </span><span style="color: #007700">= </span><span style="color: #0000BB">mcrypt_get_iv_size</span><span style="color: #007700">(</span><span style="color: #0000BB">MCRYPT_RIJNDAEL_128</span><span style="color: #007700">, </span><span style="color: #0000BB">MCRYPT_MODE_CBC</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$hmac_raw </span><span style="color: #007700">= </span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">, </span><span style="color: #0000BB">false</span><span style="color: #007700">, </span><span style="color: #0000BB">NULL</span><span style="color: #007700">,  </span><span style="color: #0000BB">0</span><span style="color: #007700">, </span><span style="color: #0000BB">32</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$hmac_salt </span><span style="color: #007700">= </span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">, </span><span style="color: #0000BB">false</span><span style="color: #007700">, </span><span style="color: #0000BB">NULL</span><span style="color: #007700">, </span><span style="color: #0000BB">32</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$hmac_calc </span><span style="color: #007700">= </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">calculate_hmac_after_32bytes</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$hmac_salt</span><span style="color: #007700">, </span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$fc </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #0000BB">$aes_filename</span><span style="color: #007700">, </span><span style="color: #DD0000">"rb"</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$fout </span><span style="color: #007700">= </span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #0000BB">$out_stream</span><span style="color: #007700">, </span><span style="color: #DD0000">'wb'</span><span style="color: #007700">);<br />      if (!empty(</span><span style="color: #0000BB">$fout</span><span style="color: #007700">) &amp;&amp; !empty(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">) &amp;&amp; </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">hash_equals</span><span style="color: #007700">(</span><span style="color: #0000BB">$hmac_raw</span><span style="color: #007700">,</span><span style="color: #0000BB">$hmac_calc</span><span style="color: #007700">)) {<br />         </span><span style="color: #0000BB">fread</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">32</span><span style="color: #007700">+</span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">);</span><span style="color: #FF8000">//skip sha256 hmac and salt<br />         </span><span style="color: #0000BB">$esalt </span><span style="color: #007700">= </span><span style="color: #0000BB">fread</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$iv    </span><span style="color: #007700">= </span><span style="color: #0000BB">fread</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">$iv_size</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$ekey </span><span style="color: #007700">= </span><span style="color: #0000BB">hash_pbkdf2</span><span style="color: #007700">(</span><span style="color: #DD0000">"sha256"</span><span style="color: #007700">, </span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$esalt</span><span style="color: #007700">, </span><span style="color: #0000BB">$it</span><span style="color: #007700">=</span><span style="color: #0000BB">1000</span><span style="color: #007700">, </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">key_size</span><span style="color: #007700">(), </span><span style="color: #0000BB">$raw</span><span style="color: #007700">=</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">$opts </span><span style="color: #007700">= array(</span><span style="color: #DD0000">'mode'</span><span style="color: #007700">=&gt;</span><span style="color: #DD0000">'cbc'</span><span style="color: #007700">, </span><span style="color: #DD0000">'iv'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">, </span><span style="color: #DD0000">'key'</span><span style="color: #007700">=&gt;</span><span style="color: #0000BB">$ekey</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">stream_filter_append</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #DD0000">'mdecrypt.rijndael-128'</span><span style="color: #007700">, </span><span style="color: #0000BB">STREAM_FILTER_READ</span><span style="color: #007700">, </span><span style="color: #0000BB">$opts</span><span style="color: #007700">);<br />         while (!</span><span style="color: #0000BB">feof</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">)) {<br />            </span><span style="color: #0000BB">$block </span><span style="color: #007700">= </span><span style="color: #0000BB">fread</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">, </span><span style="color: #0000BB">8192</span><span style="color: #007700">);<br />            if (</span><span style="color: #0000BB">feof</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">)) {<br />               </span><span style="color: #0000BB">$padding </span><span style="color: #007700">= </span><span style="color: #0000BB">ord</span><span style="color: #007700">(</span><span style="color: #0000BB">$block</span><span style="color: #007700">[</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$block</span><span style="color: #007700">) - </span><span style="color: #0000BB">1</span><span style="color: #007700">]);</span><span style="color: #FF8000">//assume PKCS7 padding<br />               </span><span style="color: #0000BB">$block </span><span style="color: #007700">= </span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$block</span><span style="color: #007700">, </span><span style="color: #0000BB">0</span><span style="color: #007700">, </span><span style="color: #0000BB">0</span><span style="color: #007700">-</span><span style="color: #0000BB">$padding</span><span style="color: #007700">);<br />            }<br />            </span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fout</span><span style="color: #007700">, </span><span style="color: #0000BB">$block</span><span style="color: #007700">);<br />         }<br />         </span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fout</span><span style="color: #007700">);<br />         </span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fc</span><span style="color: #007700">);<br />      }<br />   }<br />   private static function </span><span style="color: #0000BB">hash_equals</span><span style="color: #007700">(</span><span style="color: #0000BB">$str1</span><span style="color: #007700">, </span><span style="color: #0000BB">$str2</span><span style="color: #007700">) {<br />      if(</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$str1</span><span style="color: #007700">) == </span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$str2</span><span style="color: #007700">)) {<br />         </span><span style="color: #0000BB">$res </span><span style="color: #007700">= </span><span style="color: #0000BB">$str1 </span><span style="color: #007700">^ </span><span style="color: #0000BB">$str2</span><span style="color: #007700">;<br />         for(</span><span style="color: #0000BB">$ret</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">,</span><span style="color: #0000BB">$i </span><span style="color: #007700">= </span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">) - </span><span style="color: #0000BB">1</span><span style="color: #007700">; </span><span style="color: #0000BB">$i </span><span style="color: #007700">&gt;= </span><span style="color: #0000BB">0</span><span style="color: #007700">; </span><span style="color: #0000BB">$i</span><span style="color: #007700">--) </span><span style="color: #0000BB">$ret </span><span style="color: #007700">|= </span><span style="color: #0000BB">ord</span><span style="color: #007700">(</span><span style="color: #0000BB">$res</span><span style="color: #007700">[</span><span style="color: #0000BB">$i</span><span style="color: #007700">]);<br />         return !</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br />      }<br />      return </span><span style="color: #0000BB">false</span><span style="color: #007700">;<br />   }<br />   private static function </span><span style="color: #0000BB">calculate_hmac_after_32bytes</span><span style="color: #007700">(</span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$hsalt</span><span style="color: #007700">, </span><span style="color: #0000BB">$filename</span><span style="color: #007700">) {<br />      static </span><span style="color: #0000BB">$init</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />      </span><span style="color: #0000BB">$init </span><span style="color: #007700">or </span><span style="color: #0000BB">$init </span><span style="color: #007700">= </span><span style="color: #0000BB">stream_filter_register</span><span style="color: #007700">(</span><span style="color: #DD0000">"user-filter.skipfirst32bytes"</span><span style="color: #007700">, </span><span style="color: #DD0000">"FileSkip32Bytes"</span><span style="color: #007700">);<br />      </span><span style="color: #0000BB">$stream </span><span style="color: #007700">= </span><span style="color: #DD0000">'php://filter/read=user-filter.skipfirst32bytes/resource=' </span><span style="color: #007700">. </span><span style="color: #0000BB">$filename</span><span style="color: #007700">;<br />      </span><span style="color: #0000BB">$hkey </span><span style="color: #007700">= </span><span style="color: #0000BB">hash_pbkdf2</span><span style="color: #007700">(</span><span style="color: #DD0000">"sha256"</span><span style="color: #007700">, </span><span style="color: #0000BB">$password</span><span style="color: #007700">, </span><span style="color: #0000BB">$hsalt</span><span style="color: #007700">, </span><span style="color: #0000BB">$iterations</span><span style="color: #007700">=</span><span style="color: #0000BB">1000</span><span style="color: #007700">, </span><span style="color: #0000BB">24</span><span style="color: #007700">, </span><span style="color: #0000BB">$raw</span><span style="color: #007700">=</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />      return </span><span style="color: #0000BB">hash_hmac_file</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">, </span><span style="color: #0000BB">$stream</span><span style="color: #007700">, </span><span style="color: #0000BB">$hkey</span><span style="color: #007700">, </span><span style="color: #0000BB">$raw</span><span style="color: #007700">=</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />   }<br />}<br />class </span><span style="color: #0000BB">FileSkip32Bytes </span><span style="color: #007700">extends </span><span style="color: #0000BB">php_user_filter<br /></span><span style="color: #007700">{<br />   private </span><span style="color: #0000BB">$skipped</span><span style="color: #007700">=</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />   function </span><span style="color: #0000BB">filter</span><span style="color: #007700">(</span><span style="color: #0000BB">$in</span><span style="color: #007700">, </span><span style="color: #0000BB">$out</span><span style="color: #007700">, &amp;</span><span style="color: #0000BB">$consumed</span><span style="color: #007700">, </span><span style="color: #0000BB">$closing</span><span style="color: #007700">)  {<br />      while (</span><span style="color: #0000BB">$bucket </span><span style="color: #007700">= </span><span style="color: #0000BB">stream_bucket_make_writeable</span><span style="color: #007700">(</span><span style="color: #0000BB">$in</span><span style="color: #007700">)) {<br />         </span><span style="color: #0000BB">$outlen </span><span style="color: #007700">= </span><span style="color: #0000BB">$bucket</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">datalen</span><span style="color: #007700">;<br />         if (</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">skipped</span><span style="color: #007700">&lt;</span><span style="color: #0000BB">32</span><span style="color: #007700">){<br />            </span><span style="color: #0000BB">$outlen </span><span style="color: #007700">= </span><span style="color: #0000BB">min</span><span style="color: #007700">(</span><span style="color: #0000BB">$bucket</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">datalen</span><span style="color: #007700">,</span><span style="color: #0000BB">32</span><span style="color: #007700">-</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">skipped</span><span style="color: #007700">);<br />            </span><span style="color: #0000BB">$bucket</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">data </span><span style="color: #007700">= </span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$bucket</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">data</span><span style="color: #007700">, </span><span style="color: #0000BB">$outlen</span><span style="color: #007700">);<br />            </span><span style="color: #0000BB">$bucket</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">datalen </span><span style="color: #007700">= </span><span style="color: #0000BB">$bucket</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">datalen</span><span style="color: #007700">-</span><span style="color: #0000BB">$outlen</span><span style="color: #007700">;<br />            </span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">skipped</span><span style="color: #007700">+=</span><span style="color: #0000BB">$outlen</span><span style="color: #007700">;<br />         }<br />         </span><span style="color: #0000BB">$consumed </span><span style="color: #007700">+= </span><span style="color: #0000BB">$outlen</span><span style="color: #007700">;<br />         </span><span style="color: #0000BB">stream_bucket_append</span><span style="color: #007700">(</span><span style="color: #0000BB">$out</span><span style="color: #007700">, </span><span style="color: #0000BB">$bucket</span><span style="color: #007700">);<br />      }<br />      return </span><span style="color: #0000BB">PSFS_PASS_ON</span><span style="color: #007700">;<br />   }<br />}<br />class </span><span style="color: #0000BB">AES_128_CBC </span><span style="color: #007700">extends </span><span style="color: #0000BB">AES_CBC </span><span style="color: #007700">{<br />   protected static function </span><span style="color: #0000BB">key_size</span><span style="color: #007700">() { return </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">$KEY_SIZES</span><span style="color: #007700">[</span><span style="color: #DD0000">'AES-128'</span><span style="color: #007700">]; }<br />}<br />class </span><span style="color: #0000BB">AES_192_CBC </span><span style="color: #007700">extends </span><span style="color: #0000BB">AES_CBC </span><span style="color: #007700">{<br />   protected static function </span><span style="color: #0000BB">key_size</span><span style="color: #007700">() { return </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">$KEY_SIZES</span><span style="color: #007700">[</span><span style="color: #DD0000">'AES-192'</span><span style="color: #007700">]; }<br />}<br />class </span><span style="color: #0000BB">AES_256_CBC </span><span style="color: #007700">extends </span><span style="color: #0000BB">AES_CBC </span><span style="color: #007700">{<br />   protected static function </span><span style="color: #0000BB">key_size</span><span style="color: #007700">() { return </span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">$KEY_SIZES</span><span style="color: #007700">[</span><span style="color: #DD0000">'AES-256'</span><span style="color: #007700">]; }<br />}</span>
</span>
</code></div>
     </div>

    </div>
   </div>
  </div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="121484""></a>
  <div class="note">
   <strong class="user">Maarten Bodewes</strong>
   <a href="#121484" class="date">06-Aug-2017 12:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The examples on this page should be destroyed with utmost urgency.<br />
<br />
Strangely most people will fall over the use of generating the IV and 3DES key using MD5, a weak hash function, e.g. the previous note and CryptoFails blog.<br />
<br />
<a href="http://www.cryptofails.com/post/70059608390/php-documentation-woes" rel="nofollow" target="_blank">http://www.cryptofails.com/post/70059608390/php-documentation-woes</a><br />
<br />
A password based key derivation function should be used (bcrypt, PBKDF2).<br />
<br />
However the use of MD-5 for key derivation however isn't that bad and if the password is strong enough (it usually isn't) then the generated DES ABC key is strong enough even now.<br />
&nbsp;<br />
Using an identical IV for each password means that this function directly leaks information about the encrypted file. If the start of two encrypted files is identical then this function will directly leak information. For instance, if the routine encrypts multiple images then the JPEG header would be easily distinguished.<br />
<br />
All in all these examples use deprecated routines (mcrypt), deprecated cryptographic functions (MD5 / DES) and then incorrectly perform the actual encryption. Enough reason to destroy them in the first place.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="120692""></a>
  <div class="note">
   <strong class="user">Uwe Ohse</strong>
   <a href="#120692" class="date">22-Feb-2017 04:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
1) The mcrypt module has been deprecated with PHP 7.1.<br />
What does that mean for the encryption filters?<br />
<br />
2) deriving the IV from the secret passphrase seems wrong. This leaks information about the passphrase without need.<br />
<br />
3) using md5() for this? Really? hash() has been available since PHP 5.1.2.<br />
<br />
4) hashing the passphrase twice does not add any security.<br />
<br />
5) using substr() on binary data (why, oh why, is true passed to md5()?) might lead to headaches if mbstring.func_overload is used.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
