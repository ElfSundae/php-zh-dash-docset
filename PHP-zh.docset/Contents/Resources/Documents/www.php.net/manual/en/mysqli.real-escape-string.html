<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>根据当前连接的字符集，对于 SQL 语句中的特殊字符进行转义</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="mysqli.real-connect.html">? mysqli::real_connect</a></li>
      <li style="float: right;"><a href="mysqli.real-query.html">mysqli::real_query ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="class.mysqli.html">MySQLi</a></li>
    <li>根据当前连接的字符集，对于 SQL 语句中的特殊字符进行转义</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="mysqli.real-escape-string" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mysqli::real_escape_string</h1>
  <h1 class="refname">mysqli::escape_string</h1>
  <h1 class="refname">mysqli_real_escape_string</h1>
  <p class="verinfo">(PHP 5, PHP 7)</p><p class="refpurpose"><span class="refname">mysqli::real_escape_string</span> -- <span class="refname">mysqli::escape_string</span> -- <span class="refname">mysqli_real_escape_string</span> &mdash; <span class="dc-title">根据当前连接的字符集，对于 SQL 语句中的特殊字符进行转义</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-mysqli.real-escape-string-description">
  <h3 class="title">说明</h3>
  <p class="para">面向对象风格</p>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><a href="function.mysqli-escape-string.html" class="methodname">mysqli::escape_string</a></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$escapestr</code></span>
   ) : <span class="type">string</span></div>

  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>mysqli::real_escape_string</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$escapestr</code></span>
   ) : <span class="type">string</span></div>

  <p class="para rdfs-comment">过程化风格</p>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>mysqli_real_escape_string</strong></span>
    ( <span class="methodparam"><span class="type"><a href="class.mysqli.html" class="type mysqli">mysqli</a></span> <code class="parameter">$link</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$escapestr</code></span>
   ) : <span class="type">string</span></div>

  <p class="para rdfs-comment">
   此函数用来对字符串中的特殊字符进行转义，
   以使得这个字符串是一个合法的 SQL 语句。
   传入的字符串会根据当前连接的字符集进行转义，得到一个编码后的合法的 SQL 语句。
  </p>
  <div class="caution"><strong class="caution">Caution</strong>
   <h1 class="title">安全：默认字符集</h1>
   <p class="para">
    在调用 <span class="function"><strong>mysqli_real_escape_string()</strong></span> 
    函数之前，
    必须先通过调用 <span class="function"><a href="mysqli.set-charset.html" class="function">mysqli_set_charset()</a></span> 
    函数或者在 MySQL 服务器端设置字符集。
    更多信息请参考 <a href="mysqlinfo.concepts.charset.html" class="link">字符集</a>。
   </p>
  </div>
 </div>


 <div class="refsect1 parameters" id="refsect1-mysqli.real-escape-string-parameters">
  <h3 class="title">参数</h3>
  <p class="para">
   <dl>

    <dt>
<code class="parameter">
link</code></dt>
<dd>
<p class="para">仅以过程化样式：由<span class="function"><a href="function.mysqli-connect.html" class="function">mysqli_connect()</a></span> 或 <span class="function"><a href="mysqli.init.html" class="function">mysqli_init()</a></span>
返回的链接标识。</p></dd>

    
     <dt>
<code class="parameter">escapestr</code></dt>

     <dd>

      <p class="para">
       需要进行转义的字符串。
      </p>
      <p class="para">
       会被进行转义的字符包括： <em>NUL （ASCII 0），\n，\r，\，&#039;，&quot; 和
       Control-Z</em>.
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-mysqli.real-escape-string-returnvalues">
  <h3 class="title">返回值</h3>
  <p class="para">
   转义后的字符串。
  </p>
 </div>

 
 <div class="refsect1 errors" id="refsect1-mysqli.real-escape-string-errors">
  <h3 class="title">错误／异常</h3>
  <p class="para">
   在无效的连接上调用此函数会返回
   <strong><code>NULL</code></strong> 并发出一个 <strong><code>E_WARNING</code></strong> 级别的错误。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-mysqli.real-escape-string-examples">
  <h3 class="title">范例</h3>
  <div class="example" id="example-1882">
   <p><strong>Example #1 <span class="methodname"><strong>mysqli::real_escape_string()</strong></span> 例程</strong></p>
   <div class="example-contents"><p>面向对象风格</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;检查连接&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"CREATE&nbsp;TEMPORARY&nbsp;TABLE&nbsp;myCity&nbsp;LIKE&nbsp;City"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$city&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"'s&nbsp;Hertogenbosch"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*&nbsp;由于未对&nbsp;$city&nbsp;进行转义，此次查询会失败&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;into&nbsp;myCity&nbsp;(Name)&nbsp;VALUES&nbsp;('</span><span style="color: #0000BB">$city</span><span style="color: #DD0000">')"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Error:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">sqlstate</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">$city&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">real_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$city</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;对&nbsp;$city&nbsp;进行转义之后，查询可以正常执行&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;into&nbsp;myCity&nbsp;(Name)&nbsp;VALUES&nbsp;('</span><span style="color: #0000BB">$city</span><span style="color: #DD0000">')"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%d&nbsp;Row&nbsp;inserted.\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">affected_rows</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>过程化风格</p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;检查连接&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"CREATE&nbsp;TEMPORARY&nbsp;TABLE&nbsp;myCity&nbsp;LIKE&nbsp;City"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$city&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"'s&nbsp;Hertogenbosch"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*&nbsp;由于未对&nbsp;$city&nbsp;进行转义，此次查询会失败&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(!</span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"INSERT&nbsp;into&nbsp;myCity&nbsp;(Name)&nbsp;VALUES&nbsp;('</span><span style="color: #0000BB">$city</span><span style="color: #DD0000">')"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Error:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_sqlstate</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">));<br />}<br /><br /></span><span style="color: #0000BB">$city&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_real_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$city</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;对&nbsp;$city&nbsp;进行转义之后，查询可以正常执行&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_query</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"INSERT&nbsp;into&nbsp;myCity&nbsp;(Name)&nbsp;VALUES&nbsp;('</span><span style="color: #0000BB">$city</span><span style="color: #DD0000">')"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%d&nbsp;Row&nbsp;inserted.\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_affected_rows</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">));<br />}<br /><br /></span><span style="color: #0000BB">mysqli_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>以上例程会输出：</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
Error: 42000
1 Row inserted.
</pre></div>
   </div>
  </div>
 </div>


 <div class="refsect1 notes" id="refsect1-mysqli.real-escape-string-notes">
  <h3 class="title">注释</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <p class="para">
    如果你之前都是使用 <span class="function"><a href="function.mysql-real-escape-string.html" class="function">mysql_real_escape_string()</a></span> 函数来转义 SQL 语句的，
    那么需要注意的是 <span class="function"><strong>mysqli_real_escape_string()</strong></span> 和
    <span class="function"><a href="function.mysql-real-escape-string.html" class="function">mysql_real_escape_string()</a></span> 两个函数的参数顺序不同。
    <span class="function"><strong>mysqli_real_escape_string()</strong></span> 中，
    <code class="parameter">link</code> 是第一个参数，
    而在 <span class="function"><a href="function.mysql-real-escape-string.html" class="function">mysql_real_escape_string()</a></span> 函数中，要转义的字符串是第一个参数。
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-mysqli.real-escape-string-seealso">
  <h3 class="title">参见</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="mysqli.set-charset.html" class="function" rel="rdfs-seeAlso">mysqli_set_charset()</a> - 设置默认字符编码</span></li>
    <li class="member"><span class="function"><a href="mysqli.character-set-name.html" class="function" rel="rdfs-seeAlso">mysqli_character_set_name()</a> - 返回当前数据库连接的默认字符编码</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="123313""></a>
  <div class="note">
   <strong class="user">David Spector</strong>
   <a href="#123313" class="date">06-Nov-2018 10:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I think two additional characters need to be removed or escaped to protect from injection: ` (accent grave) and ; (semicolon). Accent grave could be used to inject into table and key names, terminating them too early (if user input is allowed as table or key names), and semicolon could be used to insert additional statements into an SQL statement. Always use ` (accent grave) to surround table, key, and column names, and always use ' (apostrophe) to surround column values in SQL statements, especially if the names or values can ever contain spaces.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="122016""></a>
  <div class="note">
   <strong class="user">Lawrence DOliveiro</strong>
   <a href="#122016" class="date">13-Dec-2017 03:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that the "like" operator requires an *additional* level of escaping for its special characters, *on top of* that performed by mysql_escape_string. But there is no built-in function for performing this escaping. Here is a function that does it:<br />
<br />
function escape_sql_wild($s)<br />
&nbsp; /* escapes SQL pattern wildcards in s. */<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; $result = array();<br />
&nbsp;&nbsp;&nbsp; foreach(str_split($s) as $ch)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ($ch == "\\" || $ch == "%" || $ch == "_")<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $result[] = "\\";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } /*if*/<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $result[] = $ch;<br />
&nbsp;&nbsp; &nbsp;&nbsp; } /*foreach*/<br />
&nbsp;&nbsp;&nbsp; return<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; implode("", $result);<br />
&nbsp; } /*escape_sql_wild*/</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="121402""></a>
  <div class="note">
   <strong class="user">therselman at gmail dot com</strong>
   <a href="#121402" class="date">19-Jul-2017 08:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Presenting several UTF-8 / Multibyte-aware escape functions.<br />
<br />
These functions represent alternatives to mysqli::real_escape_string, as long as your DB connection and Multibyte extension are using the same character set (UTF-8), they will produce the same results by escaping the same characters as mysqli::real_escape_string.<br />
<br />
This is based on research I did for my SQL Query Builder class:<br />
https://github.com/twister-php/sql<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/**<br />
&nbsp;* Returns a string with backslashes before characters that need to be escaped.<br />
&nbsp;* As required by MySQL and suitable for multi-byte character sets<br />
&nbsp;* Characters encoded are NUL (ASCII 0), \n, \r, \, ', ", and ctrl-Z.<br />
&nbsp;*<br />
&nbsp;* @param string $string String to add slashes to<br />
&nbsp;* @return $string with `\` prepended to reserved characters <br />
&nbsp;*<br />
&nbsp;* @author Trevor Herselman<br />
&nbsp;*/<br />
</span><span class="keyword">if (</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'mb_ereg_replace'</span><span class="keyword">))<br />
{<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mb_ereg_replace</span><span class="keyword">(</span><span class="string">'[\x00\x0A\x0D\x1A\x22\x27\x5C]'</span><span class="keyword">, </span><span class="string">'\\\0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
} else {<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'~[\x00\x0A\x0D\x1A\x22\x27\x5C]~u'</span><span class="keyword">, </span><span class="string">'\\\$0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Characters escaped are (the same as mysqli::real_escape_string):<br />
<br />
00 = \0 (NUL)<br />
0A = \n<br />
0D = \r<br />
1A = ctl-Z<br />
22 = "<br />
27 = '<br />
5C = \<br />
<br />
Note: preg_replace() is in PCRE_UTF8 (UTF-8) mode (`u`).<br />
<br />
Enhanced version:<br />
<br />
When escaping strings for `LIKE` syntax, remember that you also need to escape the special characters _ and %<br />
<br />
So this is a more fail-safe version (even when compared to mysqli::real_escape_string, because % characters in user input can cause unexpected results and even security violations via SQL injection in LIKE statements):<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/**<br />
&nbsp;* Returns a string with backslashes before characters that need to be escaped.<br />
&nbsp;* As required by MySQL and suitable for multi-byte character sets<br />
&nbsp;* Characters encoded are NUL (ASCII 0), \n, \r, \, ', ", and ctrl-Z.<br />
&nbsp;* In addition, the special control characters % and _ are also escaped,<br />
&nbsp;* suitable for all statements, but especially suitable for `LIKE`.<br />
&nbsp;*<br />
&nbsp;* @param string $string String to add slashes to<br />
&nbsp;* @return $string with `\` prepended to reserved characters <br />
&nbsp;*<br />
&nbsp;* @author Trevor Herselman<br />
&nbsp;*/<br />
</span><span class="keyword">if (</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'mb_ereg_replace'</span><span class="keyword">))<br />
{<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mb_ereg_replace</span><span class="keyword">(</span><span class="string">'[\x00\x0A\x0D\x1A\x22\x25\x27\x5C\x5F]'</span><span class="keyword">, </span><span class="string">'\\\0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
} else {<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">mb_escape</span><span class="keyword">(</span><span class="default">string $string</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'~[\x00\x0A\x0D\x1A\x22\x25\x27\x5C\x5F]~u'</span><span class="keyword">, </span><span class="string">'\\\$0'</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Additional characters escaped:<br />
<br />
25 = %<br />
5F = _<br />
<br />
Bonus function:<br />
<br />
The original MySQL `utf8` character-set (for tables and fields) only supports 3-byte sequences.<br />
4-byte characters are not common, but I've had queries fail to execute on 4-byte UTF-8 characters, so you should be using `utf8mb4` wherever possible.<br />
<br />
However, if you still want to use `utf8`, you can use the following function to replace all 4-byte sequences.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Modified from: https://stackoverflow.com/a/24672780/2726557<br />
</span><span class="keyword">function </span><span class="default">mysql_utf8_sanitizer</span><span class="keyword">(</span><span class="default">string $str</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'/[\x{10000}-\x{10FFFF}]/u'</span><span class="keyword">, </span><span class="string">"\xEF\xBF\xBD"</span><span class="keyword">, </span><span class="default">$str</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Pick your poison and use at your own risk!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="119571""></a>
  <div class="note">
   <strong class="user">James</strong>
   <a href="#119571" class="date">09-Jul-2016 02:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To escape for the purposes of having your queries made successfully, and to prevent SQLi (SQL injection)/stored and/or reflected XSS, it's a good idea to go with the basics first, then make sure nothing gets in that can be used for SQLi or stored/reflected XSS, or even worse, loading remote images and scripts.<br />
<br />
For example:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// Assume this is a simple comments form with a name and comment.<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$name </span><span class="keyword">= </span><span class="default">mysqli_real_escape_string</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'name'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$comments </span><span class="keyword">= </span><span class="default">mysqli_real_escape_string</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'comments'</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// Here is where most of the action happens.&nbsp; But see note below<br />
&nbsp;&nbsp; &nbsp; // on dumping back out from the database<br />
<br />
&nbsp;&nbsp; &nbsp; // We should use the ENT_QUOTES flag second parameter...<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$name </span><span class="keyword">= </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$name</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$comments </span><span class="keyword">= </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$comments</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$insert_sql </span><span class="keyword">= </span><span class="string">"INSERT INTO tbl_comments ( c_id, c_name, c_comments ) VALUES ( DEFAULT, '" </span><span class="keyword">. </span><span class="default">$name </span><span class="keyword">. </span><span class="string">"', '" </span><span class="keyword">. </span><span class="default">$comments </span><span class="keyword">. </span><span class="string">"')"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$res </span><span class="keyword">= </span><span class="default">mysqli_query</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="default">$insert_sql</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; if ( </span><span class="default">$res </span><span class="keyword">=== </span><span class="default">false </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Something went wrong, handle it<br />
&nbsp;&nbsp; &nbsp; </span><span class="keyword">}<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="comment">// Now output page showing comments<br />
</span><span class="default">?&gt;<br />
</span><br />
//&nbsp; Assume we're in a table with each row containing a name and comment<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; $res </span><span class="keyword">= </span><span class="default">mysqli_query</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="string">"SELECT c_name, c_comments FROM tbl_comments ORDER BY c_name ASC"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; if ( </span><span class="default">$res </span><span class="keyword">=== </span><span class="default">false </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Something went wrong<br />
<br />
&nbsp;&nbsp; &nbsp; // Or as you like...<br />
&nbsp;&nbsp; &nbsp; </span><span class="keyword">while ( </span><span class="default">$row </span><span class="keyword">= </span><span class="default">mysqli_fetch_array</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">, </span><span class="default">MYSQLI_BOTH</span><span class="keyword">) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// This will output safe HTML entities if they went in<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // They will be displayed, but not interpreted<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"&lt;tr&gt;&lt;td&gt;" </span><span class="keyword">. </span><span class="default">$row</span><span class="keyword">[</span><span class="string">'c_name'</span><span class="keyword">] . </span><span class="string">"&lt;/td&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&lt;td&gt;" </span><span class="keyword">. </span><span class="default">$row</span><span class="keyword">[</span><span class="string">'c_comments'</span><span class="keyword">] . </span><span class="string">"&lt;/td&gt;&lt;/tr&gt;"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// BUT, if you make this mistake...<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"&lt;tr&gt;&lt;td&gt;" </span><span class="keyword">. </span><span class="default">htmlspecialchars_decode</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'c_name'</span><span class="keyword">]) . </span><span class="string">"&lt;/td&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&lt;td&gt;" </span><span class="keyword">. </span><span class="default">htmlspecialchars_decode</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'c_comments'</span><span class="keyword">]) . </span><span class="string">"&lt;/td&gt;&lt;/tr&gt;"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// ... then your entities will reflect back as the characters, so<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // input such as this: "&gt;&lt;img src=x onerror=alert('xss')&gt;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // will display the 'xss' in an alert box in the browser.<br />
&nbsp;&nbsp; &nbsp; </span><span class="keyword">}<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">mysqli_free_result</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">mysqli_close</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
In most cases, you wouldn't want to go way overboard sanitizing untrusted user input, for instance:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; $my_input </span><span class="keyword">= </span><span class="default">htmlspecialchars</span><span class="keyword">( </span><span class="default">strip_tags</span><span class="keyword">(</span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'foo'</span><span class="keyword">]) );<br />
</span><span class="default">?&gt;<br />
</span><br />
This will junk a lot of input you might actually want, if you're rolling your own forum or comments section and it's for web developers, for example.&nbsp; On the other hand, if legitimate users are never going to enter anything other than text, never HTML tags or anything else, it's not a bad idea.<br />
<br />
The take-away is that mysqli_real_escape_string() is not good enough, and being overly-aggressive in sanitizing input may not be what you want.<br />
<br />
Be aware that in the above example, it will protect you from sqli (run sqlmap on all your input fields and forms to check) but it won't protect your database from being filled with junk, effectively DoS'ing your Web app in the process.<br />
<br />
So after protecting against SQLi, even if you're behind CloudFlare and take other measures to protect your databases, there's still effectively a DoS attack that could slow down your Web App for legitimate users and make it a nightmare filled with rubbish that some poor maintainer has to clean out, if you don't take other measures.<br />
<br />
So aside from escaping your stings, and protecting against SQLi and stored/reflected XSS, and maliciously loaded images or JS, there's also checking your input to see if it makes sense, so you don't get a database full of rubbish!<br />
<br />
It just never ends... :-)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="116946""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#116946" class="date">25-Mar-2015 09:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you wonder why (besides \, ' and ")&nbsp; NUL (ASCII 0), \n, \r, and Control-Z are escaped: it is not to prevent sql injection, but to prevent your sql logfile to get unreadable.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113658""></a>
  <div class="note">
   <strong class="user">zanferrari at gmail dot com</strong>
   <a href="#113658" class="date">11-Nov-2013 08:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When I submit data through Ajax I use a little function to reconvert the encoded chars to their original value. After that I do the escaping. Here the function:<br />
<br />
&nbsp;&nbsp; function my_htmlentities($input){<br />
&nbsp;&nbsp; &nbsp; &nbsp; $string = htmlentities($input,ENT_NOQUOTES,'UTF-8');<br />
&nbsp;&nbsp; &nbsp; &nbsp; $string = str_replace('&amp;euro;',chr(128),$string);<br />
&nbsp;&nbsp; &nbsp; &nbsp; $string = html_entity_decode($string,ENT_NOQUOTES,'ISO-8859-15');<br />
&nbsp;&nbsp; &nbsp; &nbsp; return $string;<br />
&nbsp;&nbsp; }<br />
<br />
G.Zanferrari</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102639""></a>
  <div class="note">
   <strong class="user">dave at mausner.us</strong>
   <a href="#102639" class="date">25-Feb-2011 07:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can avoid all character escaping issues (on the PHP side) if you use prepare() and bind_param(), as an alternative to placing arbitrary string values in SQL statements.&nbsp; This works because bound parameter values are NOT passed via the SQL statement syntax.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96429""></a>
  <div class="note">
   <strong class="user">Josef Toman</strong>
   <a href="#96429" class="date">26-Feb-2010 06:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For percent sign and underscore I use this:<br />
<span class="default">&lt;?php<br />
$more_escaped </span><span class="keyword">= </span><span class="default">addcslashes</span><span class="keyword">(</span><span class="default">$escaped</span><span class="keyword">, </span><span class="string">'%_'</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58650""></a>
  <div class="note">
   <strong class="user">tobias_demuth at web dot de</strong>
   <a href="#58650" class="date">10-Nov-2005 08:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note, that if no connection is open, mysqli_real_escape_string() will return an empty string!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46339""></a>
  <div class="note">
   <strong class="user">arnoud at procurios dot nl</strong>
   <a href="#46339" class="date">07-Oct-2004 09:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that this function will NOT escape _ (underscore) and % (percent) signs, which have special meanings in LIKE clauses. <br />
<br />
As far as I know there is no function to do this, so you have to escape them yourself by adding a backslash in front of them.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
