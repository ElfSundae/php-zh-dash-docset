<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=gb2312">
  <title>WeakMap 类</title>
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-base.css" />
<link media="all" rel="stylesheet" type="text/css" href="styles/03e73060321a0a848018724a6c83de7f-theme-medium.css" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="weakreference.get.html">? WeakReference::get</a></li>
      <li style="float: right;"><a href="weakmap.count.html">WeakMap::count ?</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="reserved.interfaces.html">预定义接口和类</a></li>
    <li>WeakMap 类</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="class.weakmap" class="reference">

 <h1 class="title">WeakMap 类</h1>
 

 <div class="partintro"><p class="verinfo">(PHP 8)</p>

  
  <div class="section" id="weakmap.intro">
   <h2 class="title">简介</h2>
   <p class="para">
    <span class="classname"><strong class="classname">WeakMap</strong></span> 是将对象作为 key 来访问的 map（或者说字典）。然而，与其它类似 <span class="classname"><a href="class.splobjectstorage.html" class="classname">SplObjectStorage</a></span> 
    不同，<span class="classname"><strong class="classname">WeakMap</strong></span> 中的对象 key 不影响对象的引用计数。也就是说，如果在任何时候对其唯一的剩余引用是 
    <span class="classname"><strong class="classname">WeakMap</strong></span> key，那么该对象将会被垃圾收集并从 <span class="classname"><strong class="classname">WeakMap</strong></span> 
    移除。它的主要用法是从对象中编译数据派生缓存，这种场景下不需要存活得比对象更久。
   </p>
   <p class="para">
    <span class="classname"><strong class="classname">WeakMap</strong></span> 实现了 <span class="interfacename"><a href="class.arrayaccess.html" class="interfacename">ArrayAccess</a></span>、
    <span class="interfacename"><a href="class.traversable.html" class="interfacename">Traversable</a></span>（通过 <span class="interfacename"><a href="class.iteratoraggregate.html" class="interfacename">IteratorAggregate</a></span>）和
    <span class="interfacename"><a href="class.countable.html" class="interfacename">Countable</a></span>，
    因此大多数情况下，它能和关联数组一样使用。
   </p>
  </div>
  

  <div class="section" id="weakmap.synopsis">
   <h2 class="title">类摘要</h2>

   
   <div class="classsynopsis"><div class="classsynopsisinfo">
    
     <span class="modifier">final</span>
     <span class="modifier">class</span> <strong class="classname"><strong class="classname">WeakMap</strong></strong>
    

    
     <span class="modifier">implements</span>
      <a href="class.arrayaccess.html" class="interfacename">ArrayAccess</a>,

     <a href="class.countable.html" class="interfacename">Countable</a>,

     <a href="class.iteratoraggregate.html" class="interfacename">IteratorAggregate</a> {</div>

    <div class="classsynopsisinfo classsynopsisinfo_comment">/* 方法 */</div>
    <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="methodname"><a href="weakmap.count.html" class="methodname">count</a></span>(): <span class="type"><a href="language.types.integer.html" class="type int">int</a></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="weakmap.getiterator.html" class="methodname">getIterator</a></span>(): <span class="type"><a href="class.iterator.html" class="type Iterator">Iterator</a></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="weakmap.offsetexists.html" class="methodname">offsetExists</a></span>(<span class="methodparam"><span class="type"><a href="language.types.object.html" class="type object">object</a></span> <code class="parameter">$object</code></span>): <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="weakmap.offsetget.html" class="methodname">offsetGet</a></span>(<span class="methodparam"><span class="type"><a href="language.types.object.html" class="type object">object</a></span> <code class="parameter">$object</code></span>): <span class="type"><a href="language.types.mixed.html" class="type mixed">mixed</a></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="weakmap.offsetset.html" class="methodname">offsetSet</a></span>(<span class="methodparam"><span class="type"><a href="language.types.object.html" class="type object">object</a></span> <code class="parameter">$object</code></span>, <span class="methodparam"><span class="type"><a href="language.types.mixed.html" class="type mixed">mixed</a></span> <code class="parameter">$value</code></span>): <span class="type"><a href="language.types.void.html" class="type void">void</a></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="weakmap.offsetunset.html" class="methodname">offsetUnset</a></span>(<span class="methodparam"><span class="type"><a href="language.types.object.html" class="type object">object</a></span> <code class="parameter">$object</code></span>): <span class="type"><a href="language.types.void.html" class="type void">void</a></span></div>

   }</div>
   

  </div>
  
  <div class="section" id="weakmap.examples">
   <h2 class="title">示例</h2>
   <p class="para">
    <div class="example" id="example-396">
     <p><strong>Example #1 <span class="classname"><strong class="classname">Weakmap</strong></span> 用法示例</strong></p>
     <div class="example-contents">
      <div class="phpcode"><code><span style="color: #000000"><span style="color: #0000BB">&lt;?php<br />$wm </span><span style="color: #007700">= new </span><span style="color: #0000BB">WeakMap</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$o </span><span style="color: #007700">= new </span><span style="color: #0000BB">stdClass</span><span style="color: #007700">;<br /><br />class </span><span style="color: #0000BB">A </span><span style="color: #007700">{<br />    public function </span><span style="color: #0000BB">__destruct</span><span style="color: #007700">() {<br />        echo </span><span style="color: #DD0000">"Dead!\n"</span><span style="color: #007700">;<br />    }<br />}<br /><br /></span><span style="color: #0000BB">$wm</span><span style="color: #007700">[</span><span style="color: #0000BB">$o</span><span style="color: #007700">] = new </span><span style="color: #0000BB">A</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$wm</span><span style="color: #007700">));<br />echo </span><span style="color: #DD0000">"Unsetting...\n"</span><span style="color: #007700">;<br />unset(</span><span style="color: #0000BB">$o</span><span style="color: #007700">);<br />echo </span><span style="color: #DD0000">"Done\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$wm</span><span style="color: #007700">));</span></span></code></div>
     </div>

     <div class="example-contents"><p>以上示例会输出：</p></div>
     <div class="example-contents screen">
      <div class="cdata"><pre>
int(1)
Unsetting...
Dead!
Done
int(0)
</pre></div>
     </div>
    </div>
   </p>
  </div>
  

 </div>

 





 






 





 





 





 






<h2>Table of Contents</h2><ul class="chunklist chunklist_reference"><li><a href="weakmap.count.html">WeakMap::count</a> &mdash; 统计 map 中存活实体的数量</li><li><a href="weakmap.getiterator.html">WeakMap::getIterator</a> &mdash; 接收一个外部迭代器</li><li><a href="weakmap.offsetexists.html">WeakMap::offsetExists</a> &mdash; 检测 map 中是否存在某个对象</li><li><a href="weakmap.offsetget.html">WeakMap::offsetGet</a> &mdash; 返回某个对象指向的值</li><li><a href="weakmap.offsetset.html">WeakMap::offsetSet</a> &mdash; 更新 map 新的键值对</li><li><a href="weakmap.offsetunset.html">WeakMap::offsetUnset</a> &mdash; 从 map 中移除一条</li></ul>
</div>
<div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="129369""></a>
  <div class="note">
   <strong class="user">Anton</strong>
   <a href="#129369" class="date">02-Apr-2024 08:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Keep in mind that if Enum case is put as a key to WeakMap, it will never be removed because it will always have unless 1 reference to it under the hood (not sure why, probably because enum is basically a constant).<br />
Therefore, both WeakMaps below will always have key Enum::Case. However, you still are able to unset it manually:<br />
<br />
$weakMap = new WeakMap();<br />
$object = Enum::Case;<br />
<br />
$weakMap[$object] = 123;<br />
unset($object);<br />
var_dump($weakMap-&gt;count());&nbsp; // 1<br />
<br />
///<br />
<br />
$weakMap = new WeakMap();<br />
$weakMap[Enum::Case] = 123;<br />
var_dump($weakMap-&gt;count());&nbsp; // 1<br />
<br />
///<br />
<br />
$weakMap = new WeakMap();<br />
$weakMap[Enum::Case] = 123;<br />
unset($weakMap[Enum::Case]);<br />
var_dump($weakMap-&gt;count());&nbsp; // 0</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="129050""></a>
  <div class="note">
   <strong class="user">Samu</strong>
   <a href="#129050" class="date">17-Nov-2023 10:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP's implementation of WeakMap allows for iterating over the contents of the weak map, hence it's important to understand why it is sometimes dangerous and requires careful thought.<br />
<br />
If the objects of the WeakMap are "managed" by other services such as Doctrine's EntityManager, it is never safe to assume that if the object still exists in the weak map, it is still managed by Doctrine and therefore safe to consume. <br />
<br />
Doctrine might have already thrown that entity away but some unrelated piece of code might still hold a reference to it, hence it still existing in the map as well.<br />
<br />
If you are placing managed objects into the WeakMap and later iterating over the WeakMap (e.g. after Doctrine flush), then for each such object you must verify that it is still valid in the context of the source of the object.<br />
<br />
For example assigning a detached Doctrine entity to another entity's property would result in errors about non-persisted / non-managed entities being found in the hierarchy.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
